<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Utility Bills</title>
    <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body>
    <%- include('../partials/navbar') %>

    <div class="container mt-5">
      <div class="card p-4 shadow-sm">
        <h1 class="mb-4 text-center">
          Edit Utility Bill for Unit <%= utilityBill.unit_no %>
        </h1>

        <form action="/utilityBills/edit/<%= utilityBill.util_id %>" method="POST">
          <input type="hidden" id="utilSettingId" name="utilSettingId" value="<%= utilityBill.utilsetting_id %>" />
          <input
            type="hidden"
            id="total_amt"
            name="total_amt"
            value="<%= utilityBill.total_amt %>"
          />
          <input
            type="hidden"
            name="unit_id"
            value="<%= utilityBill.unit_id %>"
          />

          <div class="row">
            <!-- Utility Type Selection -->
            <div class="col-md-6 mb-3">
                <label for="utilityType" class="form-label">Utility Type</label>
                <select id="utilityType" class="form-select" required>
                    
                    <% if (rates.water) { %>
                    <option value="water" <%= utilityBill.category === 'water' ? 'selected' : '' %>>
                        Water
                    </option>
                    <% } %>
                    
                    <% if (rates.electricity) { %>
                    <option value="electricity" <%= utilityBill.category === 'electricity' ? 'selected' : '' %>>
                        Electricity
                    </option>
                    <% } %>

                    <% if (rates.internet) { %>
                    <option value="internet" <%= utilityBill.category === 'internet' ? 'selected' : '' %>>
                        Internet
                    </option>
                    <% } %>

                </select>
            </div>

            <div class="col-md-6 mb-3">
              <label for="rate" class="form-label">Utility Bill Rate:</label>
              <input
                type="number"
                class="form-control"
                id="rate"
                name="rate"
                value="<%= utilityBill.rate %>"
                readonly
                disabled
              />
            </div>
          </div>

          <!-- Total Display Area -->
          <div class="alert alert-info text-center" role="alert">
            <h4 class="alert-heading">Total Amount Due</h4>
            <p class="mb-0 fs-2 fw-bold">
              â‚±<span id="totalAmountDisplay"
                ><%= parseFloat(utilityBill.total_amt).toLocaleString('en-US', {
                minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span
              >
            </p>
          </div>

          <div class="row" id="readingFields">
            <div class="col-md-6 mb-3">
              <label for="prev_reading" class="form-label"
                >Previous Reading:</label
              >
              <input
                type="number"
                class="form-control"
                id="prev_reading"
                name="prev_reading"
                placeholder="e.g., 1500"
                value="<%= utilityBill.prev_reading %>"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="curr_reading" class="form-label"
                >Current Reading:</label
              >
              <input
                type="number"
                class="form-control"
                id="curr_reading"
                name="curr_reading"
                placeholder="e.g., 1650"
                value="<%= utilityBill.curr_reading %>"
                required
              />
              <div class="invalid-feedback">
                Current reading cannot be less than previous reading.
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label for="adjustment" class="form-label">Adjustment Fee:</label>

              <!-- Input group puts the button on the right side of the textbox -->
              <div class="input-group">
                <input
                  type="number"
                  class="form-control"
                  id="adjustment"
                  name="adjustment"
                  placeholder="e.g., 1650"
                  value="<%= utilityBill.adjustment %>"
                  step="any"
                  disabled
                />
                <button type="button" class="btn btn-primary" id="sendOtpBtn">
                  Send OTP
                </button>
              </div>

              <!-- OTP Section -->
              <div class="col-12 mt-3" id="otpSection" style="display: none">
                <label class="form-label">Enter OTP:</label>

                <div class="input-group mb-2">
                  <input
                    type="number"
                    class="form-control"
                    id="otpInput"
                    placeholder="Enter OTP"
                  />
                  <button
                    type="button"
                    class="btn btn-success"
                    id="verifyOtpBtn"
                  >
                    Verify OTP
                  </button>
                </div>

                <div id="otpAlertContainer"></div>
              </div>
            </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="start_date" class="form-label"
                >Billing Period Start:</label
              >
              <input
                type="date"
                class="form-control"
                id="start_date"
                name="start_date"
                value="<%= utilityBill.start_date %>"
                disabled
              />
            </div>
            <div class="col-md-4 mb-3">
              <label for="end_date" class="form-label"
                >Billing Period End:</label
              >
              <input
                type="date"
                class="form-control"
                id="end_date"
                name="end_date"
                value="<%= utilityBill.end_date %>"
                disabled
              />
            </div>
            <div class="col-md-4 mb-3">
              <label for="due_date" class="form-label">Due Date:</label>
              <input
                type="date"
                class="form-control"
                id="due_date"
                name="due_date"
                value="<%= utilityBill.due_date %>"
                disabled
              />
            </div>
          </div>

          <div class="d-flex justify-content-end mt-4">
            <a
              href="/utilityBills/<%= utilityBill.unit_id %>"
              class="btn btn-secondary me-2"
              >Cancel</a
            >
            <button type="submit" class="btn btn-primary">Edit Bill</button>
          </div>
        </form>
      </div>
    </div>

    <script src="/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Client-side script for dynamic calculation -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const ratesData = {
          water: <%- JSON.stringify(rates.water || null) %>,
          electricity: <%- JSON.stringify(rates.electricity || null) %>,
          internet: <%- JSON.stringify(rates.internet || null) %>
        };

        const utilityTypeSelect = document.getElementById("utilityType");
        const rateInput = document.getElementById("rate");
        const utilSettingIdInput = document.getElementById("utilSettingId");
        const prevReadingInput = document.getElementById("prev_reading");
        const currReadingInput = document.getElementById("curr_reading");
        const totalAmountDisplay = document.getElementById("totalAmountDisplay");
        const totalAmountHiddenInput = document.getElementById("total_amt");
        const readingFields = document.getElementById("readingFields");
        const adjustmentInput = document.getElementById("adjustment");

        const startDateInput = document.getElementById("start_date");
        const endDateInput = document.getElementById("end_date");
        const dueDateInput = document.getElementById("due_date");

        function calculateAndDisplayTotal() {
          const rate = parseFloat(rateInput.value) || 0;
          const selectedType = utilityTypeSelect.value;

            if (selectedType === "internet") {
            const total = rate;
            totalAmountDisplay.textContent = total.toLocaleString("en-US", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
            totalAmountHiddenInput.value = total.toFixed(2);
            return;
          }

          const prevReading = parseFloat(prevReadingInput.value) || 0;
          const currReading = parseFloat(currReadingInput.value) || 0;
          const adjustment = parseFloat(adjustmentInput.value) || 0;

          if (currReading > 0 && currReading < prevReading) {
            currReadingInput.classList.add("is-invalid");
            totalAmountDisplay.textContent = "0.00";
            totalAmountHiddenInput.value = "0.00";
            return;
          } else {
            currReadingInput.classList.remove("is-invalid");
          }

          const consumption = currReading - prevReading;
          const total = (consumption * rate) + adjustment;

          totalAmountDisplay.textContent = total.toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });

          totalAmountHiddenInput.value = total.toFixed(2);
        }

        function toggleReadingFields() {
          const selectedType = utilityTypeSelect.value;

          if (selectedType === "internet") {
            readingFields.style.display = "none";
            prevReadingInput.removeAttribute("required");
            currReadingInput.removeAttribute("required");

            prevReadingInput.value = "";
            currReadingInput.value = "";
            currReadingInput.classList.remove("is-invalid");
          } else {
            readingFields.style.display = "flex";
            prevReadingInput.setAttribute("required", "required");
            currReadingInput.setAttribute("required", "required");
          }
        }

        function formatDateForInput(date) {
          const d = new Date(date);
          const year = d.getFullYear();
          const month = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");
          return `${year}-${month}-${day}`;
        }

        utilityTypeSelect.addEventListener("change", function () {
          const selectedType = this.value;
          const selectedRateData = ratesData[selectedType];

          if (selectedRateData) {
            rateInput.value = selectedRateData.rate;
            utilSettingIdInput.value = selectedRateData.utilSettingId;

            startDateInput.value = formatDateForInput(selectedRateData.start_date);
            endDateInput.value = formatDateForInput(selectedRateData.end_date);
            dueDateInput.value = formatDateForInput(selectedRateData.due_date);
          } else {
            rateInput.value = "";
            utilSettingIdInput.value = "";

            startDateInput.value = "";
            endDateInput.value = "";
            dueDateInput.value = "";
          }

          toggleReadingFields();
          calculateAndDisplayTotal();
        });

        prevReadingInput.addEventListener("input", calculateAndDisplayTotal);
        currReadingInput.addEventListener("input", calculateAndDisplayTotal);
        adjustmentInput.addEventListener("input", calculateAndDisplayTotal);
      });

      document.addEventListener("DOMContentLoaded", () => {
        const sendOtpBtn = document.getElementById("sendOtpBtn");
        const verifyOtpBtn = document.getElementById("verifyOtpBtn");

        const otpInput = document.getElementById("otpInput");
        const otpAlertContainer = document.getElementById("otpAlertContainer");

        const adjustmentInput = document.getElementById("adjustment");
        const otpSection = document.getElementById("otpSection");

        sendOtpBtn.addEventListener("click", async () => {
          otpAlertContainer.innerHTML = "";

          otpSection.style.display = "block";

          try {
            const response = await fetch (
              `/utilityBills/edit/<%= utilityBill.unit_id %>/send-otp`,
              {
                method: "POST"
              }
            );

            const data = await response.json();

            if (data.success) {
              otpAlertContainer.innerHTML = `
                <div class="alert alert-info alert-dismissible fade show" role="alert">
                  OTP has been sent to your email.
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              `;
            } else {
              otpAlertContainer.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                  Failed to send OTP. Try again.
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              `;
            }
          } catch (err) {
              otpAlertContainer.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show" alert="role">
                  Error sending OTP.
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              `;
          }
        });

        verifyOtpBtn.addEventListener("click", async () => {
          const otpValue = otpInput.value;

          if(!otpValue) {
            otpAlertContainer.innerHTML = `
              <div class="alert alert-warning alert-dismissible fade show" role="alert">
                Please enter the OTP.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            `;
            return;
          };

          try {
            const response = await fetch(
              `/utilityBills/edit/<%= utilityBill.unit_id %>/verify-otp`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ otp: otpValue }),
              }
            );

            const data = await response.json();

            if (data.valid === true) {
              otpAlertContainer.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                  OTP verified successfully!
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              `;

              adjustmentInput.disabled = false;
            } else {
              otpAlertContainer.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                  Incorrect OTP. Please try again.
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              `;

              adjustmentInput.disabled = true;
            }
          } catch (err) {
            otpAlertContainer.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                  Error verifying OTP.
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
          }
        });
      });
    </script>
  </body>
</html>
